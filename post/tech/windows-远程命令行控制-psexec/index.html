<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="referrer" content="never">
﻿		<meta data-draft-node="block" data-draft-type="table" data-size="normal" data-row-style="normal">
        <title>Windows 远程命令行控制--PsExec</title>
        
        <style>

    html body {
        font-family: '', sans-serif;
        background-color: white;
    }

    :root {
        --accent: purple;
        --border-width:  5px ;
    }

</style>


<link rel="stylesheet" href="/blog/css/main.css">








 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" crossorigin="anonymous">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />
 

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/javascript.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/scala.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/swift.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
    
    <script>hljs.initHighlightingOnLoad();</script>






<script src="https://code.jquery.com/jquery-3.4.1.js"></script>


<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>
 <meta name="generator" content="Hugo 0.62.2" />
        

        

        
            <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
		
            <script src="//cdn.jsdelivr.net/npm/@waline/client"></script>
        

        

    </head>

    <body>
        

        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand visible-xs" href="#">Windows 远程命令行控制--PsExec</a>
                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div class="collapse navbar-collapse">
                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/blog/">Home</a></li>
                            
                                <li><a href="/blog/post/">Posts</a></li>
                            
                                <li><a href="/blog/tags/">Tags</a></li>
                            
                                <li><a href="/blog/about/">About</a></li>
                            
                        </ul>
                    
                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="https://github.com/hui1hui2hui3/"><i class="fab fa-github"></i></a></li>
                            
                        </ul>
                    
                </div>
            </div>
        </nav>


<main>

    <div>
        <h2>Windows 远程命令行控制--PsExec</h2>
        <h5>July 19, 2017</h5>
        
<a href="/blogtags/windows"><kbd class="item-tag">Windows</kbd></a>


    </div>

    <div align="start" class="content"><h2 id="下载地址">下载地址</h2>
<p><a href="https://technet.microsoft.com/en-ca/sysinternals/bb897553.aspx">PsExec 下载地址</a></p>
<h2 id="用法">用法</h2>
<p>两台windows都安装psexec即可！并都添加到系统PATH</p>
<pre><code>psexec \\remote-desktop-name -u name -p pass cmd
</code></pre><h2 id="高级示例">高级示例</h2>
<pre><code>@echo off
set iot_server_pid=0
set username=%1
set password=%2
set winname=%3

for /f &quot;tokens=2,5 delims=- &quot; %%a in ('psexec \\%winname% -u %username% -p %password% -s netstat -ano ^| findstr &quot;8080&quot;') do (
	if %%b NEQ 0 set iot_server_pid=%%b
)
echo --------find pid:-----------
echo %iot_server_pid%

if %iot_server_pid% NEQ 0 (
psexec \\%winname% -u %username% -p %password% -s taskkill /F /PID %iot_server_pid%
echo -----start wait----
ping 127.0.0.1 -n 61 &gt; nul
echo -------end wait-------
)
psexec \\%winname% -u %username% -p %password% -s -d -w D:\KYEE-IOT start-service.bat
exit 0
</code></pre><p><strong>注意：<code>-s</code>为了jenkins不出现“句柄无效错误”</strong>
<strong>注意：<code>^|</code>是windows命令管道的转义，for语句中要注意</strong>
<strong>注意：<code>-d</code>是为了不等待脚本的执行，继续执行</strong></p>
<h2 id="问题">问题</h2>
<h3 id="winserver-2008系统使用其他非adminstrator但是是管理员的账户拒绝访问的问题">WinServer 2008系统使用其他非Adminstrator，但是是管理员的账户，拒绝访问的问题</h3>
<p>错误如下：</p>
<pre><code>拒绝访问
</code></pre><p>解决方法如下：Remote 服务器上执行如下命令</p>
<pre><code>reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\system /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f
</code></pre><h3 id="句柄无效的错误如何处理">句柄无效的错误如何处理</h3>
<pre><code>句柄无效
</code></pre><p>解决方法： 加上<code>-s</code>参数</p>
<pre><code>psexec -s cmd
</code></pre><h2 id="参考">参考</h2>
<p><a href="https://technet.microsoft.com/en-us/sysinternals/bb897553.aspx">Psexec语法文档</a>
<a href="http://stackoverflow.com/questions/22553588/run-batch-scripts-on-a-remote-server-windows-from-jenkins">Run batch scripts on a remote server (windows) from jenkins</a></p>
</div>

    
    
    
        <h4 class="page-header">Related</h4>
         <div class="item">

    
    
    

    
    

    <h4><a href="/blog/post/tech/windows-%E7%9D%A1%E7%9C%A0%E7%AD%89%E5%BE%85%E6%9C%BA%E5%88%B6-timeoutwaitforping/">Windows 睡眠等待机制 timeout,waitfor,ping</a></h4>
    <h5>October 30, 2017</h5>
    
<a href="/blogtags/windows"><kbd class="item-tag">Windows</kbd></a>

<a href="/blogtags/batch"><kbd class="item-tag">Batch</kbd></a>



</div>
  <div class="item">

    
    
    

    
    

    <h4><a href="/blog/post/tech/windows-%E6%9F%A5%E8%AF%A2%E6%9D%80%E8%BF%9B%E7%A8%8B-taskkilltasklisttskill/">Windows 查询进程和杀进程--taskkill,tasklist,tskill</a></h4>
    <h5>May 22, 2017</h5>
    
<a href="/blogtags/windows"><kbd class="item-tag">Windows</kbd></a>



</div>
 
    

    
    
	
	
		<div id="waline"></div>
		<script>
			Waline({
			  el: '#waline',
			  serverURL: 'https://myblog-waline-5cpzcds7x-hui1hui2hui3-gmailcom.vercel.app',
			});
		 </script>
	
	

</main>

        <footer>
            <p class="copyright text-muted">© All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a>.</p>
        </footer>

        

        
    </body>

</html>

